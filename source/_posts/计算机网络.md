---
title: 计算机网络
date: 2020-06-25 14:12:14
tags: 网络基础
categories: interview
---

# 概述
- - -
## 主机之间的通信方式
 - 客户-服务器（C/S）：客户是服务的请求方，服务器是服务的提供方。
 - 对等（P2P）：不区分客户和服务器。
## 电路交换与分组交换
1. 电路交换：电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终占用该链路。
2. 分组交换：每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。
## 时延
总时延 = (排队时延 + 处理时延 + 传输时延)(路由器中) + 传播时延(路由器间)
1. 排队时延：分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。
2. 处理时延：主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。
3. 传输时延：主机或路由器传输数据帧所需要的时间。
4. 传播时延：电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。
## 计算机网络体系结构
1. 五层协议
      - - -
      - 应用层：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等协议。数据单位为报文。
         - DNS：域名系统是一个分布式数据库，提供了主机名和 IP 地址之间相互转换的服务。DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性
         - FTP：文件传送协议使用 TCP 进行连接，它需要两个连接来传送一个文件：
            - 控制连接：服务器打开端口号 21 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
            - 数据连接：用来传送一个文件数据。根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：
                  - 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为 20，客户端的端口号随机，但是必须大于 1024，因为 0~1023 是熟知端口号。要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。
                  - 被动模式：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。要求服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。
         - DHCP：动态主机配置协议提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。使用的端口号为67/68，传输层协议为UDP。DHCP 配置的内容不仅是 IP 地址，还包括子网掩码、网关 IP 地址。
         - TELNET：远程登录协议用于登录到远程主机上，并且远程主机上的输出也会返回。使用的端口号为23，传输层协议为TCP。
         - 电子邮件协议：包含发送协议和读取协议，发送协议常用 SMTP(使用的端口号为25，传输层协议为TCP)，读取协议常用 POP3(使用的端口号为110，传输层协议为TCP) 和 IMAP(使用的端口号为143，传输层协议为TCP)。
      - - -
      - 传输层：为进程提供通用数据传输服务，运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。
         - UDP和TCP的特点：
            - 用户数据报协议UDP是无连接的，尽最大可能交付，没有拥塞控制，面向报文支持一对一、一对多、多对一和多对多的通信
            - 传输控制协议TCP是面向连接的、提供可靠交付，有超时重传、滑动窗口、拥塞控制、流量控制，提供面向字节流的一对一的全双工通信
         - TCP的三次握手：
            1. 首先服务器端S处于LISTENH状态，等待来自客户端C的连接请求
            2. C向S发送连接请求报文，SYN=1，ACK=0，选择一个初始的序列号X
            3. S收到C收到连接请求报文，如果同意建立连接，则向C发送连接确认报文，SYN=1，ACK=1，确认号为X+1，同时也选择一个初始的序号Y
            4. C收到S的连接确认报文后，还要向S发出确认，确认号为Y+1，序号为X+1
            5. S收到C的确认后，连接建立
         - 三次握手的原因：发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果有第三次握手，客户端会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。
         - TCP的四次挥手：
            1. 客户端C发送连接释放报文，FIN=1
            2. 服务端S收到请求后发出确认，进入CLOSE-WAIT 状态，此时TCP属于半关闭状态，服务端S可以继续向客户端C发送数据但是发过来不行
            3. 当服务端S不再需要连接时，发送连接释放报文，FIN=1
            4. C收到后发出确认，进入TIME-WAIT状态，等待2MSL后释放连接
            5. S收到C的确认后释放连接
         - 四次挥手的原因：客户端收到服务端发送的FIN报文后还需要等待2MSL时间，确保最后一个报文能够到达。因为如果服务端没有收到客户端的确认报文，那么就会重新发送连接释放请求报文，A等待一段时间就是为了处理这种情况的发生；同时也是为了让本连接持续时间内产生的所有报文从网络中消失，使得下次连接不会出现旧的连接请求报文
         - TCP的拥塞控制：
            1. 慢开始与拥塞避免：
                  - 发送的最初执行慢开始，令 cwnd = 1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 ...
                  - 注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能性也就更高。设置一个慢开始门限 ssthresh，当 cwnd >= ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1
                  - 如果出现了超时，则令 ssthresh = cwnd / 2，然后重新执行慢开始
            2. 快重传与快恢复：
                  - 在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认
                  - 在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3
                  - 在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh = cwnd / 2 ，cwnd = ssthresh，注意到此时直接进入拥塞避免
                  - 慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh
      - - -
      - 网络层：为主机提供数据传输服务。而传输层协议是为主机中的进程提供数据传输服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。
         - 与 IP 协议配套使用的还有三个协议：
               - 地址解析协议 ARP（Address Resolution Protocol）
               - 网际控制报文协议 ICMP（Internet Control Message Protocol）
               - 网际组管理协议 IGMP（Internet Group Management Protocol）
         - 地址解析协议ARP:
               - 网络层实现主机之间的通信，而链路层实现具体每段链路之间的通信。因此在通信过程中，IP 数据报的源地址和目的地址始终不变，而 MAC 地址随着链路的改变而改变
               - ARP 实现由 IP 地址得到 MAC 地址
         - 网际控制报文协议ICMP
               - Ping是 ICMP 的一个重要应用，主要用来测试两台主机之间的连通性
               - Traceroute 是 ICMP 的另一个应用，用来跟踪一个分组从源点到终点的路径
      - - -
      - 数据链路层：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
         - 信道分类：
            1. 广播信道：一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。主要有两种控制方法进行协调，一个是使用信道复用技术，一是使用 CSMA/CD 协议。
            2. 点对点信道：一对一通信。因为不会发生碰撞，因此也比较简单，使用 PPP 协议进行控制。
         - 信道复用技术：
            1. 频分复用：所有主机在相同的时间占用不同的频率带宽资源
            2. 时分复用：所有主机在不同的时间占用相同的频率带宽资源
            3. 统计时分复用：是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送
            4. 波分复用：光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波
         - CSMA/CD(载波监听多点接入 / 碰撞检测)协议：
            - 多点接入：说明这是总线型网络，许多主机以多点的方式连接到总线上
            - 载波监听：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待
            - 碰撞检测：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞
         - PPP协议：互联网用户通常需要连接到某个 ISP 之后才能接入到互联网，PPP 协议是用户计算机和 ISP 进行通信时所使用的数据链路层协议
         - MAC地址：MAC 地址是链路层地址，长度为 6 字节（48 位），用于唯一标识网络适配器（网卡）。一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址
         - 局域网：局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。可以分为星型、环形和直线型等。
         - 以太网：以太网是一种星型拓扑结构局域网。使用交换机进行连接，交换机是一种链路层设备，它不会发生碰撞，能根据MAC地址进行存储转发。
         - 交换机：交换机具有自学习能力，学习的是交换表的内容，交换表中存储着MAC地址到接口的映射。正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。
         - 虚拟局域网：VLAN可以建立与地理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。
      - - -
      - 物理层：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。
         - 通信方式：单向通信、半双工通信、全双工通信
         - 带通调制：模拟信号是连续的信号，数字信号是离散的信号。带通调制把数字信号转换为模拟信号
      - - -
2. TCP/IP协议
      - 只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。
      - TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。
## WEB页面请求过程
1. DHCP配置主机信息
      - 假设主机最开始没有 IP 地址以及其它信息，那么就需要先使用 DHCP 来获取。
      - 主机生成一个DHCP请求报文，并将这个报文放入具有目的端口67和源端口68的UDP保温段中。
      - 该报文段被放入一个具有广播IP目的地址(255.255.255.255)和源IP地址(0.0.0.0)的IP数据报中。
      - 该数据报被放置在MAC帧中，具有目的地址FF:FF:FF:FF:FF:FF，将广播到与交换机连接的所有设备。
      - 连接在交换机的DHCP服务器收到广播帧后，不断向上分解得到IP数据报、UDP报文段、DHCP请求报文，之后生成DHCP ACK报文，该报文含有以下信息：
            - IP地址
            - DNS服务器的IP地址
            - 默认网关路由器的IP地址和子网掩码
      -  DHCP ACK报文被放入UDP报文段中，UDP报文段被放入IP数据报中，最后放入MAC帧中。该帧的目的地址是请求主机的MAC地址，因为交换机具有自学习能力，之前发送了广播帧之后就记录了MAC地址到其转发接口的交换表项，因此交换机可以知道应该向哪个接口发送该MAC帧
      - 主机收到该帧后不断分解得到DHCP报文，之后配置其IP地址、子网掩码和DNS服务器IP地址，并在其IP转发表中安装默认网关
2. ARP解析MAC地址
      - 主机通过浏览器生成一个TCP套接字，套接字向HTTP服务器发送HTTP请求。为了生成该套接字，主机需要知道网站域名对应的IP地址
      - 主机生成一个DNS查询报文，该报文端口号为53
      - 该报文被放入目的地址为DNS的IP地址的IP数据报中
      - 为了获取IP数据报目的地址对应的MAC地址，需要使用ARP协议
      - 主机生成一个包含目的地址为网关路由器IP地址的ARP查询报文，将该报文放入一个具有广播目的地址(FF:FF:FF:FF:FF:FF)的以太网帧中，并向交换机发送该帧，交换机再将该帧转发给所有连接设备
      - 网关路由器接收到该帧后，不断向上解析到ARP报文，发现其中的IP地址与其接口的IP地址相符，于是发送ARP 响应报文，包含了它的MAC地址给主机
3. DNS解析域名
      - 网关路由器接收到包含DNS查询报文的MAC帧后，抽取出IP数据报，并根据转发表决定应该转发的路由器
      - 到达DNS服务器后，DNS服务器抽取出查询报文后在数据库查到待解析域名后发送响应报文
      - 响应报文放入UDP报文段中，然后放入IP数据报中，通过路由器回传到网关路由器，并经由交换机到达主机
4. HTTP请求页面
      - 在获取到HTTP服务器的IP地址后，通过三次握手建立TCP连接
      - HTTP服务器从TCP套接字读取报文后生成响应报文，将WEB页面内容发入到报文主体中返回给主机
      - 浏览器收到HTTP响应报文后，抽取WEB页面内容进行渲染展示
